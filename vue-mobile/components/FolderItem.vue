<template>
  <AppItem
    v-if="folder"
    :item="folder"
    :isSelected="folder.isSelected"
    :disable="folder.isCopied"
    :clickable="!isCopied"
    :active="folder.isSelected"
    :isChoice="isSelectMode"
    @click="listItemClick(folder)"
  >
    <q-item-section class="folder__thumb" side>
      <StorageIcon class="folder__thumb-icon" />
      <ShareWithMeItemIcon v-if="folder.sharedWithMeAccess" class="folder__thumb-share-icon" />
    </q-item-section>

    <q-item-section class="list-item__text">
      <q-item-label class="list-item__text_primary folder__name">{{ folderName }}</q-item-label>
      <q-item-label v-if="isShared" class="list-item__text_secondary folder__info">
        <SharedItemIcon class="folder__info-icon_shared" />
      </q-item-label>
    </q-item-section>

    <q-item-section v-if="!isSelectMode" class="folder__menu" side>
      <q-btn icon="more_vert" @click.stop="menuClick" color="grey" flat round />
    </q-item-section>
  </AppItem>
</template>

<script>
import { mapGetters, mapActions } from 'pinia'
import { useFilesStore } from '../store/index-pinia'

import { getShortName } from '../utils/common'

import { SHARING_LEVELS } from '../enums'
import FolderIcon from './icons/FolderIcon'
import SharedItemIcon from './icons/item/SharedItemIcon'
import ShareWithMeItemIcon from './icons/ShareWithMeItemIcon'
import AppItem from 'src/components/common/AppItem'

export default {
  name: 'FolderItem',
  components: {
    FolderIcon,
    SharedItemIcon,
    ShareWithMeItemIcon,
    AppItem
  },
  props: {
    folder: { type: Object, default: null },
    isSelectMode: { type: Boolean, default: false },
    isCopied: { type: Boolean, default: false },
    selectItemHandler: { type: Function, default: null, require: true },
    openMenuHandler: { type: Function, default: null, require: true },
  },
  computed: {
    ...mapGetters(useFilesStore, [
      'currentStorage'
    ]),
    folderName() {
      return this.folder ? getShortName(this.folder.name, 50) : ''
    },
    isShared() {
      return !!this.folder.shares.length || this.folder.sharedWithMeAccess === SHARING_LEVELS.RESHARE
    }
  },
  data() {
    return {
      isMoved: false,
    }
  },
  methods: {
    ...mapActions(useFilesStore, [
      'selectFile',
      'changeDialogComponent',
    ]),
    async openFolder() {
      if (!this.isSelectMode && !this.folder.isCopied && !this.isMoved) {
        const path = {
          path: this.folder.fullPath,
          name: this.folder.name,
        }

        const storageId = this.currentStorage?.Type || this.contact?.storage
        if (storageId) {
          await this.$router.push({ path: `/files/${storageId}${this.folder.fullPath}/` })
        }
      } else {
        this.isMoved = false
      }
    },
    listItemClick(item) {
      if (this.isSelectMode) {
        this.selectItemHandler(item)
      } else {
        this.openFolder()
      }
    },
    menuClick() {
      if (!this.isSelectMode && !this.isCopied) {
        this.selectFile(this.folder)
        this.changeDialogComponent({ component: 'FileMenuDialog' })

        // this.openMenuHandler({
        //   file: this.folder,
        //   component: 'FileMenuDialog',
        // })
      }
    },
  },
}
</script>


<style lang="scss">
.folder {
  &__thumb {
    position: relative;
  }

  &__thumb-icon {
    fill: $secondary;
  }

  &__thumb-share-icon {
    position: absolute;
    right: 6px;
    top: 0px;
  }

  &__info-icon_encrypted,
  &__info-icon_shared,
  &__info-icon_link {
    fill: $secondary;
  }
}

</style>
